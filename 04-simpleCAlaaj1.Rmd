# Täydentävät pisteet

Kartat ovat analyysin väline, ja usein on hyödyllistä esittää kuvassa
lisäinformaatiota tulkinnan avuksi. Täydentävät pisteet (supplementary points,
CAiP s. 89-) ovat rivejä tai sarakkeita jotka lisätään karttaan. Mikä tahansa 
rivi tai sarake voidaan voidaan lisätä kuvaan, jos se on järkevästi vertailukelpoinen
kartan määtittäneiden profiilien kanssa.

Tällainen piste on kartan laskennassa _passiivinen_, sillä on sijainti kartalla
mutta ei massaa eikä vaikutusta inertiaan. Passiivisilla pisteillä ei ole vaikutusta
(kontribuutiota) kartan pääakseleihin.

Täydentävillä pisteillä on kolme yleistä käyttötarkoitusta. Kartalle voidaan lisätä
profiili, joka on jollain lailla sisällöllisesti erilainen kuin muut. Esimerkkiaineistossa
kartalle voisi lisätä joitain Euroopan ulkopuolisia maita. Vaikka nämä riviprofiilit
eivät vaikuta kartan akseleiden määräytymiseen, ne voidaan esittää kuuden maan
määrittämässä "avaruudessa". Projektion laatu (suhteelliset kontribuutiot) voidaan myös
esittää.

Toinen käyttötapaus on pienen massan profiili. Tällaisella pisteellä voi olla iso
vaikutus ratkaisuun, mutta passiivisena pisteenä se sijoitetaan muiden pisteiden 
määrittämälle kartalle. Jo sisällöllisistä syistä pienen massan pisteiden esitystä
kannattaa harkita, ne sijaitsevat kaukana origosta ja huonontavat kuvan laatua.

Kolmas mahdollisuus on jakaa pistejoukkoja osajoukkoihin ja esittää niiden
summaprofiili täydentävänä pisteenä. Summaprofiili on osiensa painotettu
(barysentrinen) keskiarvo. Kun se esiteteään passiivisena pisteenä, havaintoja ei
oteta ratkaisuun kahta kertaa. Profiilien yhdistämiseen liittyy
korrespondenssianalyysin tärkein periaate, jakaumaekvivalenssi (_distributional
equivalence_). Profiileiltaan samanlaiset rivit voidaan yhdistää, analyysin tulokset
eivät muutu. Khii2-etäisyysmitta on ainoa etäisyysmitta joka toutettaa tämän
periaatteen. En esittele tätä ydinkäsitettä tämän enempää, se on ollut menetelmän
kehittämisessä tärkein tavoite. @RefWorks:doc:5a857a43e4b0ed2d44664d75 esittelevät
menetelmän matemaattiset perusteet laajemmin. 

Täydentävien profiilien lisääminen vaatii jo yksinkertaisia matriisioperaatioita.
Korrespondenssianalyysi on käytännössä matriisien muokkausta tutkimusongelman
tarpeisiin.


## Saksan ja Belgian alueet

Saksan ja Belgian aineistossa on mukana aluejako: entiset itä- ja länsi-Saksa
(dE,dW), Flanders (bF), Wallonia (bW) ja Bryssel (bB).



```{r BeDealueTable1, echo=F, eval=T}
# riviprofiilitaulukko aiheuttaa virheen PDF-tulostuksessa, JH_capaper.Rmd
# tiedoston voi kuitenkin renderöidä knit-napilla RStudiossa pdf-tiedostoksi.


BeDealueTable <- ISSP2012esim1.dat %>% tableX(maa3, Q1b, type = "row_perc")

knitr::kable(BeDealueTable , digits = 2, booktabs = TRUE,
           caption = "Q1b vastaukset, Saksan ja Belgian alueet")

```


```{r BeDeAluedat1, eval=T, include=F}

# Belgian ja Saksan aluejako maa3-muuttujassa
# str(ISSP2012esim1.dat$maa3)
# attributes(ISSP2012esim1.dat$maa3)

suppoint1_df1 <- select(ISSP2012esim1.dat, maa3,Q1b)

# Taulukoksi jotta saadaan lisättyä Saksan ja Belgian maa-profiilit täydentäviksi
# pisteiksi.

suppoint1_tab1 <- table(suppoint1_df1$maa3, suppoint1_df1$Q1b)

# tarkistus 1
# suppoint1_tab1

# Maaprofiilit lisäpisteiksi
suppoint2_df <- filter(ISSP2012esim1.dat, (maa == "BE" | maa == "DE"))
suppoint2_df <- select(suppoint2_df, maa, Q1b)
# Poistetaan maa-faktroin tyhjät luokat (14.11.2020)
suppoint2_df <- suppoint2_df %>%
    mutate(maa = fct_drop(maa)
    )


#glimpse(suppoint2_df)
suppoint2_tab1 <- table(suppoint2_df$maa, suppoint2_df$Q1b)

# tarkistus 1
# suppoint2_tab1

# lisätään rivit maa3-muuttujan taulukkoon

suppoint1_tab1 <- rbind(suppoint1_tab1, suppoint2_tab1)

# suppoint1_tab1 

```

Aineistoon lisätään passiviisina riveinä Saksan ja Belgian maaprofiilit (DE, BE).
Maiden massoja ei skaalta yhtä suuriksi, otoskoot vaikuttavat ratkaisuun.

```{r BeDealueetCA2, echo=FALSE}
# suppoint1_tab2 <- read_rds("suppoint1tab1.rds") - testaus joka siirsi virheen 07-rmd-tiedostoon. Sama virheilmoitustyyppi.

suppointCA2 <- ca(suppoint1_tab1[,1:5], suprow = 10:11)

# Sama kartta ilman täydentäviä pisteitä

suppointCA2b <- ca(suppoint1_tab1[1:9,1:5])

```



```{r suppointCA2map1, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}
# par(cex = 0.6)
plot(suppointCA2, main = "Symmetrinen kartta 1 ",
     # mass = c(TRUE, TRUE),
     # contrib = c(TRUE, FALSE),
     sub = "Täydentävät pisteet DE ja BE" )


```

Saksan ja Belgian täydentävät pisteet ovat osiensa barysentrisiä keskiarvoja,
etäisyys on sitä pienempi mitä suurempi on osuus. Saksan piste sijaitsee siksi
lähempänä länsi-Saksan pistettä. Jos karttaa vertaa kuvaan \ref(fig:simpleCA1map1)
ei eroja juuri ole. Saksan ja Belgian osien sijoittuminen on kiinnostava.
Itäinen Saksa on selvästi liberaalilla puolella, ensimmäisellä dimensiolla lähinnä Tanskaa.
Läntinen Saksa on ensimmäisellä dimensiolla konservatiivisella puolella Belgian maapisteen
tasolla. Belgian alueista Wallonia (bW) on liberaalilla puolella mutta kaikkein eniten oikealla.
Bryssel ja Flander ovat konservatiivisella puolella, toinen länsi-Saksaa
liberaalimpi ja toinen konservatiivisempi. Belgian osat hajoavat toiseen suuntaan kuin Saksan,
liberaalein Flanders on myös kaikkein maltillisin ja Bryssel vastaavasti
tiukempien mielipiteiden puolella. Sarakepisteiden suhteelliset sijainnit
toisiinsa nähden eivät oleellisesti muutu.

Bryssel ja Wallonia näyttävä olevan hyvin lievästi U-muotoisen maapisteiden 
parven sisällä. Tämä kaariefekti tai _Guttman-efekti_ on kartoissa yleinen.
Se on tavallaan seuraus ratkaisun geometriasta. Rivipisteiden pilvi on
sarakkeiden ideaalipisteiden virittämän verteksin sisällä, ja ainoa reitti
verteksin kulmasta toiseen kulkee tasolla kaarveasti (CAiP, s. 127).
Voi myös sanoa, että kaariefektin taustalla on järjestysasteikon muuttujan
korrelaatio (viite: LeRoux). Kaaren sisäpisteet ovat usein polarisoituneita
ensimmäisen dimension "ääripää-vastausten" välillä. Tässä vaikutus on heikko,
taulukossa \@ref(tab:BeDealueTable1) ei mitää selvää polariaatiota näy.


```{r suppointCA2map2, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}

plot(suppointCA2b, main = "kontribuutiokartta 1 - absoluuttiset kontribuutiot",
        map = "rowgreen",
        arrows = c(FALSE, TRUE),
        mass = c(TRUE, TRUE),
        contrib = c("absolute","absolute"),
        sub = "Massat: pisteiden ja symbolien koko " )

```


Kontribuutiokartasta täydentävät pisteet on jätetty pois, ne eivät vaikuta ratkaisuun.
Pisteiden koko auttaa hahmottamaan niiden massojen eroja, sarakkeiden massoja ei
juuri tässä kuvassa erota. Sarakkeiden kontribuutiot ovat samantapaiset kuin
alkuperäisessä kartassa \@ref(fig:G1-3asymmContrib1). Rivipisteiden kontribuutioista
osa on selvästi pienempiä, erityisesti länsi-Saksa kaksi Belgian aluetta (bB, bF).
Unkarin ja Bulgarian kontribuutiot muuttuvat eri suuntiin, Unkarin pienenee ja
Bulgarian kasvaa.


## Korrespondenssianalyysin numeeriset tulokset

Korrespondenssianalyysin numeeriset tulokset ovat tärkeitä tulkinnan varmistamiselle
ja antavat tarkemman kuvan ratkaisusta. Nämä tulokset ovat erilaisia kokonaisinertian
dekomponointeja. Kokonaisinertia (total inertia) profiilien ja keskiarvoprofiilin
khii2-etäisyyksien massoilla painotettu summa (\@ref(eq:inert2). Se kuvaa
profiilipisteiden hajontaa ideaalipisteiden verteksin sisällä. Maksimi-inertia
saavutetaan kun profiilit ovat verteksien kärkipisteissä, jokaisessa profiilissa
on vain yksi luokittelumuuttujan arvo. Inertia on sama kuin ratkaisun dimensio,
tässä esimerkissä 4(sarakkeiden lukumäärä - 1). Tärkein lähde on CAiP:n luku 11
ja liitte B.

R-paketti "ca" (versio 0.71.1) listaa numeeriset tulokset suppeasti (print) ja laajemmin
(summary), laajempi tulostus on alla.


```{r suppointCA2numres1,echo=FALSE, eval=FALSE}

print(suppointCA2)

```



Ensimmäisenä on listattu kokonaisinertia pääakseleittain. Tässä suhteelliset luvut
on esitetty prosentteina. Muut luvut on luettavuuden vuoksi skaalattu, joko kerrottu
tuhannella tai esitetty "permills" (summa on 1000).


```{r suppointCA2numres2,echo=FALSE}

summary(suppointCA2)

```
Rivi- ja sarakeprofiileista esitetään samat tiedot. Ensimmäisessä kolmen
sarakkeen joukossa kerrotaan pisteen massa, laatu (qlt) ja inertiakontribuutio.

Inertiakontribuutio on suhteellinen osuus kokonaisinertiasta. Aktiivisia rivejä on 9,
joten tasaisesti jaettu inetia olisi noin 110. Tanska, Bulgaria ja Unkari "selittävät"
suurimman osan inertiasta. Belgian ja Saksan alueiden kontribuutiot ovat pieniä.
Nämä inertiaosuudet liittyvät kokonaisinertiaan alkuperäisessä neljässä ulottuvuudessa.

Laatu kertoo miten hyvin piste on esitetty kartalla, miten suuri osa sen
inertiasta on esitetty kartalla. Kaksiulotteinen kartta kuten tässä on yleisin 
valinta, laatu kerrotaan valitulle dimensioiden määrälle. Laatu ei riipu massasta,
vaan pisteen ja kartan akseleiden välisistä kulmista (kts. teorialiite). Saksan 
osien ero laadussa on iso,itä-Saksalla erittäin hyvä ja länsi-Saksalla huono.
Belgian alueista Wallonia on kehtoiten esitetty, ja vain Flandersin laatu on
kohtuullisen hyvä. Kovin hyvä ei ole täydentävien maapisteidenkään laatu.

Kaksi seuraavaa lohkoa kertovat tulokset valituille dimenisoille eli ratkaisulle.
Molempien dimensioiden ("k=1", "k=2" ) pääkoordinaattattien (x 1000) lisäksi
raportoidaan dimension _suhteellinen kontribuutio_ pisteen inertiaan ("cor").
Nämä tunnusluvut summautuvat laaduksi (qlt), ja ne voidaan tulkita korrelaation
neliöiksi (kts. teorialiite).Erityisesti Belgian alueiden projektion laatu on
huonompi ensimmäisellä dimensiolla. Itä-Saksa ja Bulgaria taas ovat hyvin esittyjä
vain ensimmäisellä dimensiolla eivätkä juuri ollenkaan korreloi toisen dimension
kanssa.

Pisteen _absoluuttinen kontribuutio_ kertoo sen osuuden dimension inertiasta
(summa 1000). Jos katsotaan sarakkeita, nähdään E-sarake "selittää" ensimmäisen
dimension inertiasta lähes 70 prosenttia, ja dimensio saman verran
kokonaisinertiasta.


**k** Tulosteen käsitteiden esittely - tavoite kuvan laadun varmistus, akselien
tulkinnan tarkistus. Tarkemmin teorialiitteessä. Tästä pitäisi nähdä, miksi seuraavat
kartat ovat sellaisia kuin ovat. Nämä kolnme sitaattia tekstin tarkistuksen tueksi,
eivät tule lopulliseen versioon (18.11.20)

**k1** Contributions. The contribution of point to axis is a statistic that depends
both on the distance from the point to the origin point along the axis and on
the weight of the point. The contributions of points to axes are the main aid to
interpretation.

The contribution of a point to an axis is equal to the relative weight
multiplied by the squared coordinate and divided by the eigenvalue.

Note on relative contributions. 
Both the contribution of a point to an axis (Ctr) and the quality of
representation (cos2) are relative contributions, since both are obtained by
dividing the amount of variance of axis due to the point, by the variance of
axis (Ctr) and by the amount of the overall variance due to the point (cos^2),
respectively. Tästä kuva teorialiitteessä.

**k2** Varmuuden vuoksi: CAiP-laskentaliitteestä (s.263):

mass: masses (1000) of the respective row and column points;

qlt: quality of representation (out of 1000) of the point in the solution of
chosen dimensionality, in this case two-dimensional

inr: part of total inertia (out of 1000) of the point in the full space of the
rows or columns 

k=1 and k=2: principal coordinates on first two dimensions, multiplied by 1000 

cor: relative contributions (out of 1000) of each dimension to the inertia of
individual points. These are also interpreted as squared correlations (_1000)

ctr: contributions (out of 1000) of each point to the principal inertia of a dimension 

**k3** Kontribuutiot: yleisesti high contribution of a the point to the inertia of the
axis -> high relative contribution of the axis to the intertia of the point.
Ei päde kääntäen. ”Point ’secretaries’ on the first axis is extremely
well represented, but its contribution to the axis is minimal. 

 

## Esimerkki 3d- kartasta - Saksan ja Belgian dimensiot

**k** Ei kovin hyviä kuvia, mutta periaate on tärkeä. Kartta on approksimaatio,
pitää päättää milloin se on tarpeeksi hyvä. Tai mille pisteille hyvä, mille huonompi.
 
**edit 26.10.2020** summary-funktio ei toimi, kun dimensioita CA-ratkaisussa kolme.
Numeeriset tulokset voisi laskea "käsityönä". Kehno kvalitetti 2d-ratkaisussa saa
kuvissa selityksen.

**Kaksi karttaa** - **edit** 2d-ratkaisu esitetty, nyt 3d.  ca-ratkaisun akselit ovat "nested"/sisäkkäisiä.
**edit** "Kolmisormisääntö" auttaa tulkitsemaan kaksiulotteisia "oikean käden"
kuvia. Ensimmäinen dimensio on oikean käden peukalo, toinen etusormi ja kolmas
keskisormi.

Esimerkki kolmiulotteisen ratkaisun tarkasta tulkinnasta ( @RefWorks:doc:5a857a43e4b0ed2d44664d75 , s.365),
Ranskan poliitiikan dimensiot ("French political space") 1990-luvun lopulla.

 
```{r BeDealueetCA3d, echo = FALSE}
suppointCA3 <- ca(~maa3 + Q1b,ISSP2012esim1.dat, nd = 3)

# summary(suppointCA3)
# Error in rsc %*% diag(sv) : non-conformable arguments
# outo juttu, ei toimi! - TÄMÄ POISTETAAN

```
 

 
```{r suppointCA3map1, echo=FALSE, eval=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}
plot(suppointCA3, dim = c(1,2),
                main = "Kolmen dimension ratkaisu",
                sub = "symmetrinen kartta - 1. ja 2. dimensio")

```
 


Ensimmäisen ja kolmannen dimesion kuvassa näkyy pisteparven hajonta tärkeimmän
dimension ympärillä. Sarakepisteiden järjestys säilyy samana, samoin maapisteiden
oikealta vasemmalle.
 
```{r suppointCA3map2, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}
plot(suppointCA3, dim = c(1,3),
                main = "Kolmen dimension ratkaisu 1",
                sub = "symmetrinen kartta - 1. ja 3. dimensio")

```


```{r suppointCA3map3, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}
plot(suppointCA3, dim = c(2,3),
                main = "Kolmen dimension ratkaisu 2",
                sub = "symmetrinen kartta - 2. ja 3. dimensio")

```


Toisen ja kolmannen dimension kartalla on esitetty noin viidesosa kokonaisinertiasta.
Tässä Belgian pisteet ovat kuvan diagonaalilla.

**k** Tulkinta on aika hankalaa, ehkä riittää että toteaa selvän
kolmiulotteisen rakenteen jossa Belgian alueiden ero näkyy.

Kahdesta projektiosta näkee kolmannen dimension suuntaiset suurimmat poikkeamat,
niitä voi vertailla rivi- ja sarakepisteiden laatuun kaksiulotteisella kartalla.

**k** Kolmiulotteisen kuvan tulkinta pitäisi aloittaa alusta, rivi- ja sarakepisteet
hajaantuvat ulos tasosta. Ratkaisu on kuitenkin "sisäkkäinen" / "nested", kaksiuloteisen kartan
pisteet vain siirtyvät kolmannen hieman ulos tasosta. Kolmannen dimension osuus kokonaisinertiasta
on noin seitsemän prosenttia. Belgian alueiden ero näkyy erityisesti kartassa \@ref(fig:suppointCA3map3)
ja \@ref(fig:3dklippi2), samoin E-sarakkeen kohtalainen muutos.

**edit** - toinen ehkä riittää?

**k** Kuvakaappaukset ca-paketin kolmiulotteisista kuvista eivät kovin hyvin näitä eroja. Dynaamisella kuvalla pistepilvien
rakenteen hahmottaisi helpommin, tämä onnistuu useissa R-ympäristöissä.


```{r 3dklippi1, echo=FALSE, fig.cap="Saksan ja  Belgian aluejako - 3d-kuva1", out.width = "90%",fig.align = "center"}

knitr::include_graphics('img/3dSymMap_1.PNG')

```


```{r 3dklippi2, echo=FALSE, fig.cap="Saksan ja  Belgian aluejako - 3d-kuva2", out.width = "90%",fig.align = "center"}

knitr::include_graphics('img/3dSymMap_2.PNG')

```

