# Täydentävät pisteet

Kartat ovat analyysin väline, ja usein on hyödyllistä esittää kuvassa
lisäinformaatiota tulkinnan avuksi. Täydentävät pisteet (supplementary points,
CAiP s. 89-) ovat rivejä tai sarakkeita jotka lisätään karttaan. Mikä tahansa 
rivi tai sarake voidaan voidaan lisätä kuvaan, jos se on järkevästi vertailukelpoinen
kartan määtittäneiden profiilien kanssa.

Tällainen piste on kartan laskennassa _passiivinen_, sillä on sijainti kartalla
mutta ei massaa eikä vaikutusta inertiaan. Passiivisilla pisteillä ei ole vaikutusta
(kontribuutiota) kartan pääakseleihin.

Täydentävillä pisteillä on kolme yleistä käyttötarkoitusta. Kartalle voidaan lisätä
profiili, joka on jollain lailla sisällöllisesti erilainen kuin muut. Esimerkkiaineistossa
kartalle voisi lisätä joitain Euroopan ulkopuolisia maita. Vaikka nämä riviprofiilit
eivät vaikuta kartan akseleiden määräytymiseen, ne voidaan esittää kuuden maan
määrittämässä "avaruudessa". Projektion laatu (suhteelliset kontribuutiot) voidaan myös
esittää.

Toinen käyttötapaus on pienen massan profiili. Tällaisella pisteellä voi olla iso
vaikutus ratkaisuun, mutta passiivisena pisteenä se sijoitetaan muiden pisteiden 
määrittämälle kartalle. Jo sisällöllisistä syistä pienen massan pisteiden esitystä
kannattaa harkita, ne sijaitsevat kaukana origosta ja huonontavat kuvan laatua.
Esimerkkiaineistossa puuttuvat vastaukset voisi ottaa mukaan täydentävänä pisteenä.

Kolmas mahdollisuus on jakaa pistejoukkoja osajoukkoihin ja esittää niiden
summaprofiili täydentävänä pisteenä. Summaprofiili on osiensa painotettu
(barysentrinen) keskiarvo. Kun se esiteteään passiivisena pisteenä, havaintoja ei
oteta ratkaisuun kahta kertaa. Profiilien yhdistämiseen liittyy
korrespondenssianalyysin tärkein periaate, jakaumaekvivalenssi (_distributional
equivalence_). Profiileiltaan samanlaiset rivit voidaan yhdistää, analyysin tulokset
eivät muutu. Khii2-etäisyysmitta taas on ainoa etäisyysmitta joka toutettaa tämän
periaatteen. En esittele tätä ydinkäsitettä tämän enempää (kts. esim. CAiP tai
perusteellinen matemaattinen esitys [@RefWorks:doc:5a857a43e4b0ed2d44664d75]).

Täydentävien profiilien lisääminen vaatii jo yksinkertaisia matriisioperaatioita.
Korrespondenssianalyysi on käytännössä matriisien muokkausta tutkimusongelman
tarpeisiin.


## Saksan ja Belgian alueet

Saksan ja Belgian aineistossa on mukana aluejako: entiset itä- ja länsi-Saksa
(dE,dW), Flanders (bF), Wallonia (bW) ja Bryssel (bB).



```{r BeDealueTable1, echo=F, eval=T}
# riviprofiilitaulukko aiheuttaa virheen PDF-tulostuksessa, JH_capaper.Rmd
# tiedoston voi kuitenkin renderöidä knit-napilla RStudiossa pdf-tiedostoksi.


BeDealueTable <- ISSP2012esim1.dat %>% tableX(maa3, Q1b, type = "row_perc")

knitr::kable(BeDealueTable , digits = 2, booktabs = TRUE,
           caption = "Q1b vastaukset, Saksan ja Belgian alueet")

```


```{r BeDeAluedat1, eval=T, include=F}

# Belgian ja Saksan aluejako maa3-muuttujassa
# str(ISSP2012esim1.dat$maa3)
# attributes(ISSP2012esim1.dat$maa3)

suppoint1_df1 <- select(ISSP2012esim1.dat, maa3,Q1b)

# Taulukoksi jotta saadaan lisättyä Saksan ja Belgian maa-profiilit täydentäviksi
# pisteiksi.

suppoint1_tab1 <- table(suppoint1_df1$maa3, suppoint1_df1$Q1b)

# tarkistus 1
# suppoint1_tab1

# Maaprofiilit lisäpisteiksi
suppoint2_df <- filter(ISSP2012esim1.dat, (maa == "BE" | maa == "DE"))
suppoint2_df <- select(suppoint2_df, maa, Q1b)
# Poistetaan maa-faktroin tyhjät luokat (14.11.2020)
suppoint2_df <- suppoint2_df %>%
    mutate(maa = fct_drop(maa)
    )


#glimpse(suppoint2_df)
suppoint2_tab1 <- table(suppoint2_df$maa, suppoint2_df$Q1b)

# tarkistus 1
# suppoint2_tab1

# lisätään rivit maa3-muuttujan taulukkoon

suppoint1_tab1 <- rbind(suppoint1_tab1, suppoint2_tab1)

# suppoint1_tab1 

```

Aineistoon lisätään passiviisina riveinä Saksan ja Belgian maaprofiilit (DE, BE).
Maiden massoja ei skaalta yhtä suuriksi, otoskoot vaikuttavat ratkaisuun.

```{r BeDealueetCA2, echo=FALSE}
# suppoint1_tab2 <- read_rds("suppoint1tab1.rds") - testaus joka siirsi virheen 07-rmd-tiedostoon. Sama virheilmoitustyyppi.

suppointCA2 <- ca(suppoint1_tab1[,1:5], suprow = 10:11)

# Sama kartta ilman täydentäviä pisteitä

suppointCA2b <- ca(suppoint1_tab1[1:9,1:5])

```



```{r suppointCA2map1, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}
# par(cex = 0.6)
plot(suppointCA2, main = "Symmetrinen kartta 1 ",
     # mass = c(TRUE, TRUE),
     # contrib = c(TRUE, FALSE),
     sub = "Täydentävät pisteet DE ja BE" )


```

Saksan ja Belgian täydentävät pisteet ovat osiensa barysentrisiä keskiarvoja,
etäisyys on sitä pienempi mitä suurempi on osuus. Saksan piste sijaitsee siksi
lähempänä länsi-Saksan pistettä. Karttaa kannattaa verrata kuvaan jossa aluejakoa
ei ole \ref(fig:simpleCA1map1), mutta Saksan ja Belgian osien sijoittuminen on kiinnostava.
Itäinen Saksa on selvästi liberaalilla puolella, ensimmäisellä dimensiolla lähinnä Tanskaa.
Läntinen Saksa on ensimmäisellä dimensiolla konservatiivisella puolella Belgian maapisteen
tasolla. Belgian alueista Wallonia (bW) on liberaalilla puolella mutta kaikkein eniten oikealla.
Bryssel ja Flander ovat konservatiivisella puolella, toinen länsi-Saksaa liberaalimpi ja toinen konservatiivisempi. Belgian osat hajoavat toiseen suuntaan kuin Saksan,
liberaalein Flanders on myös kaikkein maltillisin ja Bryssel vastaavasti
tiukempien mielipiteiden puolella. Sarakepisteiden suhteelliset sijainnit
toisiinsa nähden eivät oleellisesti muutu.

Bryssel ja Wallonia näyttävä olevan hyvin lievästi U-muotoisen maapisteiden 
parven sisällä. Tämä kaariefekti tai _Guttman-efekti_ on kartoissa yleinen.
Se on tavallaan seuraus ratkaisun geometriasta. Rivipisteiden pilvi on
sarakkeiden ideaalipisteiden virittämän verteksin sisällä, ja ainoa reitti
verteksin kulmasta toiseen kulkee tasolla kaarveasti (VIITE: MG, CAiP).
Voi myös sanoa, että kaariefektin taustalla on järjestysasteikon muuttujan
korrelaatio (viite: LeRoux). Kaaren sisäpisteet ovat usein polarisoituneita
ensimmäisen dimension "ääripää-vastausten" välillä. Tässä vaikutus on heikko,
taulukossa \@ref(tab:BeDealueTable1) ei mitää selvää polariaatiota näy.


```{r suppointCA2map2, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}

plot(suppointCA2b, main = "kontribuutiokartta 1 - absoluuttiset kontribuutiot",
        map = "rowgreen",
        arrows = c(FALSE, TRUE),
        mass = c(TRUE, TRUE),
        contrib = c("absolute","absolute"),
        sub = "Massat: pisteiden ja symbolien koko " )

```


Kontribuutiokartasta täydentävät pisteet on jätetty pois, ne eivät vaikuta ratkaisuun.
Pisteiden koko auttaa hahmottamaan niiden massojen eroja, sarakkeiden massoja ei
juuri tässä kuvassa erota. Sarakkeiden kontribuutiot ovat samantapaiset kuin
alkuperäisessä kartassa \@ref(fig:G1-3asymmContrib1). Rivipisteiden kontribuutioista
osa on selvästi pienempiä, erityisesti länsi-Saksa kaksi Belgian aluetta (bB, bF).
Unkarin ja Bulgarian kontribuutiot muuttuvat eri suuntiin, Unkarin pienenee ja
Bulgarian kasvaa.


## Korrespondenssianalyysin numeeriset tulokset

Korrespondenssianalyysin numeeriset tulokset ovat tärkeitä tulkinnan varmistamiselle
ja antavat tarkemman kuvan ratkaisusta. Nämä tulokset ovat erilaisia kokonaisinertian
dekomponointeja. Kokonaisinertia (total inertia) profiilien ja keskiarvoprofiilin
khii2-etäisyyksien massoilla painotettu summa (\@ref(eq:inert2). Se kuvaa
profiilipisteiden hajontaa ideaalipisteiden verteksin sisällä. Maksimi-inertia
saavutetaan kun profiilit ovat verteksien kärkipisteissä, jokaisessa profiilissa on vain
yksi luokittelumuuttujan arvo. Inertia on sama kuin ratkaisun dimensio, tässä esimerkissä
4 (sarakkeiden lukumäärä - 1).^[Luku perustuu CAiP:n lukuun 11 ja liitteeseen B].

R-paketti "ca" (versio 0.71.1) listaa numeeriset tulokset suppeasti (print) ja laajemmin
(summary), laajempi tulostus on alla.^[Paketin pdf-dokumentissa s.20 kerrotaan, että print
tulostaa pääkoordinaatit (principal coordinates) mutta se tulostaakin standardikoordinaatit.]



```{r suppointCA2numres1,echo=FALSE, eval=FALSE}

# ca-paketin manuaali väittää, että tässä tulostetaan principal-koordinaatit mutta nämä ovat
# standardikoordinaatteja.
print(suppointCA2)

```



**k** Lyhyt selostus - nämä aika selkeitä

Ensimmäisenä on listattu kokonaisinertia pääakseleittain. Tässä suhteelliset luvut
on esitetty prosentteina. Muut luvut on luettavuuden vuoksi skaalattu, joko kerrottu
tuhannella tai esitetty "permills" (summa on 1000).

```{r suppointCA2numres2,echo=TRUE}

summary(suppointCA2)

```
Rivi- ja sarakeprofiileista esitetään samat tiedot. Ensimmäisessä kolmen
sarakkeen joukossa kerrotaan pisteen massa, laatu (qlt) ja inertiakontribuutio.

Inertiakontribuutio on suhteellinen osuus kokonaisinertiasta. Aktiivisia rivejä on 9,
joten tasaisesti jaettu inetia olisi noin 110. Tanska, Bulgaria ja Unkari "selittävät"
suurimman osan inertiasta. Belgian ja Saksan alueiden kontribuutiot ovat pieniä.
Nämä inertiaosuudet liittyvät kokonaisinertiaan alkuperäisessä neljässä ulottuvuudessa.

Laatu kertoo miten hyvin piste on esitetty kartalla, miten suuri osa sen
inertiasta on esitetty kartalla. Kaksiulotteinen kartta kuten tässä on yleisin 
valinta, laatu kerrotaan valitulle dimensioiden määrälle. Laatu ei riipu massasta,
vaan pisteen ja kartan akseleiden välisistä kulmista (kts. teorialiite). Saksan 
osien ero laadussa on iso,itä-Saksalla erittäin hyvä ja länsi-Saksalla huono.
Belgian alueista Wallonia on kehtoiten esitetty, ja vain Flandersin laatu on
kohtuullisen hyvä. Kovin hyvä ei ole täydentävien maapisteidenkään laatu.

Kaksi seuraavaa lohkoa kertovat tulokset valituille dimenisoille eli ratkaisulle.
Molempien dimensioiden ("k=1", "k=2" ) pääkoordinaattattien (x 1000) lisäksi
raportoidaan dimension _suhteellinen kontribuutio_ pisteen inertiaan ("cor").
Nämä tunnusluvut summautuvat laaduksi (qlt), ja ne voidaan tulkita korrelaation
neliöiksi (kts. teorialiite).Erityisesti Belgian alueiden projektion laatu on
huonompi ensimmäisellä dimensiolla. Itä-Saksa ja Bulgaria taas ovat hyvin esittyjä
vain ensimmäisellä dimensiolla eivätkä juuri ollenkaan korreloi toisen dimension
kanssa.

Pisteen _absoluuttinen kontribuutio_ kertoo sen osuuden dimension inertiasta
(summa 1000). Jos katsotaan sarakkeita, nähdään E-sarake "selittää" ensimmäisen
dimension inertiasta lähes 70 prosenttia, ja dimensio saman verran
kokonaisinertiasta.


**k** Tulosteen käsitteiden esittely - tavoite kuvan laadun varmistus, akselien
tulkinnan tarkistus. Tarkemmin teorialiitteessä. Tästä pitäisi nähdä, miksi seuraavat
kartat ovat sellaisia kuin ovat.
 

## Esimerkki 3d- kartasta - Saksan ja Belgian dimensiot

**k** Ei kovin hyviä kuvia, mutta periaate on tärkeä. Kartta on approksimaatio,
pitää päättää milloin se on tarpeeksi hyvä. Tai mille pisteille hyvä, mille huonompi.
 
**edit 26.10.2020** summary-funktio ei toimi, kun dimensioita CA-ratkaisussa kolme.
Numeeriset tulokset voisi laskea "käsityönä". Kehno kvalitetti 2d-ratkaisussa saa
kuvissa selityksen.
 
```{r BeDealueetCA3d, echo=TRUE}
suppointCA3 <- ca(~maa3 + Q1b,ISSP2012esim1.dat, nd = 3)

# summary(suppointCA3)
# Error in rsc %*% diag(sv) : non-conformable arguments
# outo juttu, ei toimi! - TÄMÄ POISTETAAN

```
 
 **Kolme karttaa**
```{r suppointCA3map1, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}
plot(suppointCA3, dim = c(1,2),
                main = "Kolmen dimension ratkaisu",
                sub = "symmetrinen kartta - 1. ja 2. dimensio")

```
 
```{r suppointCA3map2, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}
plot(suppointCA3, dim = c(1,3),
                main = "Kolmen dimension ratkaisu",
                sub = "symmetrinen kartta - 1. ja 3. dimensio")

```


```{r suppointCA3map3, echo=FALSE, fig.cap= "Q1b: Saksan ja  Belgian aluejako ",fig.asp = 1, out.width = "90%",fig.align = "center"}
plot(suppointCA3, dim = c(2,3),
                main = "Kolmen dimension ratkaisu",
                sub = "symmetrinen kartta - 2. ja 3. dimensio")

```

**k** Tulkinta.

**k** kokeilu 3d-grafiikalla - toinen riittää

```{r 3dklippi1, echo=FALSE, fig.cap="Saksan ja  Belgian aluejako - 3d-kuva1", out.width = "90%",fig.align = "center"}

knitr::include_graphics('img/3dSymMap_1.PNG')

```


```{r 3dklippi2, echo=FALSE, fig.cap="Saksan ja  Belgian aluejako - 3d-kuva2", out.width = "90%",fig.align = "center"}

knitr::include_graphics('img/3dSymMap_2.PNG')

```

