# Lähteet {-}

<div id="refs"></div>


# (APPENDIX) Liitteet {-}

# Liite 1: Korrespondenssianalyysin teoriaa {-}

## Korrespondenssianalyysin perusyhtälöt ja kaavat {-}


Perusyhtälöt on esitetty teoksen "Correspondece Analysis in Practice"[@RefWorks:doc:5a857a43e4b0ed2d44664d78]
liitteen "Theory of Correspondece Analysis" mukaisesti.

Datamatriisilla $\boldsymbol{N}$ on $I$ riviä ja $J$ sarakketta ($I x J$ ).
Alkiot ovat ei-negatiivisia (eli nollat sallittuja) ja samassa mitta-asteikossa.
Jos mitta-asteikko on intervalli- tai suhdeasteikko, mittayksiköiden on oltava
samoja (esim. euroja, metrejä). Tietyin ehdoin myös negatiiviset luvut ovat
sallittuja [@RefWorks:doc:5a857a43e4b0ed2d44664d75 s. 60].


Taulukon alkioiden summa on
$\sum_{i} \sum_{j}n_{ij} = n$, missä $i = 1, \dots , I$ ja $j = 1, \dots , J$.


Korrespondenssimatriisi  $\boldsymbol{P}$ saadaan jakamalla matriisin
$\boldsymbol{N}$  alkiot niiden summalla $n$ .

Merkitään matriisin  $\boldsymbol{P}$  rivisummien vektoria
$\boldsymbol{r}$ (= $(r_{1}, \dots, r_{I})$) ja sarakesummien vektoria
$\boldsymbol{c}$ (= $(c_{1}, \dots, c_{J})$).
Niitä vastaavat diagonaalimatriisit ovat $\boldsymbol{D_r}$ ja
$\boldsymbol{D_c}$.

Korrespondenssianalyysin ratkaistaan singluaariarvohajoitelman avulla.

Singulaariarvohajoitelma (singular value decomposition) tuottaa ratkaisun kun
sitä sovelletaan standardoituun residuaalimatriisiin $\boldsymbol{S}$.

\begin{equation}
\boldsymbol{S} = \boldsymbol{D_r}^{-1/2}(\boldsymbol{P} - \boldsymbol{r}\boldsymbol{c}^T)\boldsymbol{D_c}^{-1/2}
(\#eq:svd1)
\end{equation}

Residuaalimatriisi voidaan esittää myös ns. kontingenssi-suhdelukujen
(contingency ratio) avulla kahdella tavalla.

\begin{equation}
\boldsymbol{D_r}^{-1} \boldsymbol{P} \boldsymbol{D_c}^{-1} = \left( \frac{p_{ij}} {r_{i} c{j}} \right)
(\#eq:contrat1)
\end{equation}

\begin{equation}
\boldsymbol{S} = \boldsymbol{D_r}^{1/2} (\boldsymbol{D_r}^{-1} \boldsymbol{P} \boldsymbol{D_c}^{-1} - \boldsymbol{1}\boldsymbol{1}^{T} ) \boldsymbol{D_c}^{-1/2}  \;\;\; .
(\#eq:contrat2)
\end{equation}

Toinen esitystapa on hyödyllinen, kun tarkastellaan CA:n yhteyksiä muihin
läheisiin menetelmiin. Näitä ovat esimerkiksi "suhteellisten osuuksien datan"
 analyysi (log ratio analysis of compositiona data),moniulotteinen skaalaus,
lineaarinen diskriminanttianalyysi, kanoninen korrelaatioanalyysi,
pääkomponettianalyysi, kaksoiskuvat ja muut SVD-hajoitelmaan perustuvat dimensioden
vähentämisen menetelmät.

Samat kaavat voi esittää myös alkiomuodossa:


\begin{equation}
s_{ij} = \frac{p_{ij}-r_{i}c_{j}} { \sqrt{r_{i}c_{j} } }
(\#eq:contrat11)
\end{equation}

ja toinen
\begin{equation}
s_{ij} = \sqrt{r_{i}} \left( \frac{p_{ij}}{r_{i}c_{j}} \right) \sqrt{c_{j}} \;\;\; .
(\#eq:contrat21)
\end{equation}

Alkimuodosasa esitetyistä  kaavoista näkee rivi- ja sarakeratkaisujen sidoksen.
Ratkaisujen duaalisuus on teoreettinen tulos, jonka voi perustella täsmällisesti
algebrallisen geometrian avulla. Käytännössä rivi- ja sarekeongelman duaalisuus
 tarkoittaa sitä, että vain toinen ongelma on ratkaistava.

Singulaariarvohajoitelma (singular value decomposition, SVD) matriisille $\boldsymbol{S}$ on

\begin{equation}
\boldsymbol{S} = \boldsymbol{U} \boldsymbol{D_{\alpha}} \boldsymbol{V}^{T}
(\#eq:svd2)
\end{equation}

missä $\boldsymbol{D_{\alpha}}$ on diagonaalimatriisi, jonka alkiot ovat
singulaariarvot suuruusjärjestyksessä $\alpha_{1}\geq \alpha_{1} \geq \cdots$.


Matriisit $\boldsymbol{U}$ ja $\boldsymbol{V}$ ovat ortogonaalisia
singulaarivektoreiden matriiseja. Singulaariarvohajoitelman merkitys dimensioiden
vähentämiselle perustuu Eckart - Young - teoreemaan. Teoreema kertoo
että saamme pienimmän neliösumman $m$ - ulotteisen approksimaation matriisille
$\boldsymbol{S}$  matriisien $\boldsymbol{U}$ ja $\boldsymbol{V}$
ensimmäisten sarakkeiden ja ensimmäisten singulaariarvojen avulla.

\begin{equation}
\boldsymbol{S}_{(m)} = \boldsymbol{U}_{(m)} \boldsymbol{D}_{\alpha(m)} \boldsymbol{V}_{(m)}^{T}
(\#eq:svd3)
\end{equation}

Korrrespondenssianalyysin ratkaisualgoritmissa tätä tulosta on muokattava niin,
että rivien ja sarakkeiden massat huomioidaan pienimmän neliösumman
approksimaatiossa painoina.

Näin saadaan standardikoordinaatit ja pääkoordinaatit riveille ja
sarakkeille.

Rivien standardikoordinaatit

\begin{equation}
\boldsymbol{\Phi} = \boldsymbol{D_r}^{-\frac{1}{2}} \boldsymbol{U}
(\#eq:rivistd1)
\end{equation}

Sarakkeiden standardikoordinaatit

\begin{equation}
 \boldsymbol{\Gamma} = \boldsymbol{D_c}^{-\frac{1}{2}} \boldsymbol{V}
 (\#eq:sarakestd1)
\end{equation}

Rivien pääkoordinaatit

\begin{equation}
 \boldsymbol{F} =   \boldsymbol{D_r}^{-\frac{1}{2}} \boldsymbol{U}  \boldsymbol{D_{\alpha}} = \boldsymbol{\Phi} \boldsymbol{D_{\alpha}}
(\#eq:riviprinc1)
\end{equation}

Sarakkeiden pääkoordinaatit
\begin{equation}
 \boldsymbol{G}  = \boldsymbol{D_c}^{-\frac{1}{2}} \boldsymbol{V} \boldsymbol{D_{\alpha}} = \boldsymbol{\Gamma}  \boldsymbol{D_{\alpha}}
 (\#eq:sarakeprinc1)
\end{equation}

Pääakseleiden inertiat (principal inertias) $\lambda_{k}$

\begin{equation}
\lambda_{k} = \alpha_{k}^2, \: k = 1,\dots,K,
K = min \{ I-1, J-1 \}
\end{equation}

Ratkaisun dimenisio on myös maksimi-inertia. Tässä aineistossa ja vastaavissa
kyselytutkimusdatoissa inertia on yleensä paljon maksimia pienempi. Asymmetrisissä
kartoissa ideaalipisteet ovat kaukana origon lähelle pakkauteesta havaintojen
pilvestä.

Korespondenssianalyysi ratkaisun akseleiden inertioita kutsutaan usein ominaisarvoiksi,
mutta periaatteessa SVD-ratkaisulla saadaan singulaariarvot. Niiden neliöt ovat
akseleiden inertioita. Ominaisarvojen ja sigulaariarvojen yhteys on läheinen ja
riippuu diagonalisoitavan matriisin ominaisuuksista.


Korrespondenssimatriisi $\boldsymbol{P}$ voidaan esittää matriisi- ja
alkiomuodossa ns. palautuskaavana (reconstitution formula).

\begin{equation}
\boldsymbol{P} = \boldsymbol{D}_{r} \left( \boldsymbol{1}\boldsymbol{1}^{T} + \boldsymbol{\Phi}\boldsymbol{D}_{\lambda}^{\frac {1}{2}}\boldsymbol{\Gamma}^{T}\right)\boldsymbol{D}_{c}
(\#eq:reconstform1)
\end{equation}

\begin{equation}
p_ {ij}= r_{i}c_{j} \left(1 + \sum_{k=1}^{K} \sqrt{\lambda_{k}} \phi_{ik} \gamma_{jk} \right)
(\#eq:reconstform2)
\end{equation}

Tässä viitataan s. 101 (13.4), 109 (14.9), ja 109-110 (14.10 ja 14.11).
Palautuskavoilla on monta esitystapaa bilineaarisessa mallissa.

Rivien ja sarakkeiden riippuvuutta kuvaavat transitioyhtälöt (transition equations).

Pääkoordinaatit standardikoordinaattien funktiona (barysentrinen ominaisuus,
barycentric relationships):

\begin{equation}
\boldsymbol{F} = \boldsymbol{D}_{r}^{-1} \boldsymbol{P}\boldsymbol{\Gamma}
(\#eq:barysentr1)
\end{equation}

\begin{equation}
\boldsymbol{G} = \boldsymbol{D}_{c}^{-1} \boldsymbol{P}^{T}\boldsymbol{\Phi}
(\#eq:barysentr2)
\end{equation}

Pääkoordinaatit pääkoordinaattien funktiona:

\begin{equation}
\boldsymbol{F} = \boldsymbol{D}_{r}^{-1} \boldsymbol{P}\boldsymbol{G}\boldsymbol{D}_{\lambda}^{-\frac{1}{2}}
(\#eq:barysentr3)
\end{equation}

\begin{equation}
\boldsymbol{G} = \boldsymbol{D}_{c}^{-1} \boldsymbol{P}^{T}\boldsymbol{F}\boldsymbol{D}_{\lambda}^{-\frac{1}{2}}
(\#eq:barysentr4)
\end{equation}

Yhtälöt \@ref(eq:barysentr1) ja \@ref(eq:barysentr1) esittävät profiilipisteet ideaalipisteiden (vertex points)
painotettuina keskiarvoina, painoina profiilin elementit. Asymmetriset kartat
(rivien tai sarakkeiden suhteen) perustuvat näihin yhtälöihin. Yhtälöiden \@ref(eq:barysentr3)
ja \@ref(eq:barysentr4) kahdet pääkoordinaatit ovat perusta symmetrisille kartoille. Myös niitä
yhdistää barysentrinen painotetun keskiarvon riippuvuus, mutta mukana ovat skaalaustekijät
 $\frac{1}{\sqrt{\lambda_{i}}}$.


**Pisteet ja projektio aliavaruuteen**

Kuva on kurssimateriaaleista[@RefWorks:doc:5b6ef091e4b0984fd9b8c0ca].

```{r projectionimg1, out.width='70%', echo = F, fig.align='center',fig.cap='Pisteen projektio aliavaruuteen'}

knitr::include_graphics('img/CAquality.png')

```
Kuvassa on esitetty korrespondenssianalyysin ratkaisun minimointiongelma. Pisteen
projektio on sitä parempi mitä pienempi kulma on sentroidista pisteeseen
piirtetyn janan ja pisteen projektion välillä. COR - tunnusluku ca-funktion
numeerisissa tuloksissa tämän kulman kosinin neliö. Pisteen kuvauksen laatu (qlt)
ca-tuloksissa on valitun approsimaation akseleiden kvaliteettien (COR) summa.

Kuvasta voi myös hahmottaa sen periaatteen, että projektiossa kaukana olevat
pisteet ovat kaukana myös alkuperäisessä avaruudessa. Projektiossa lähekkäin
olevat pisteet voivat olla alkuperäisessä avaruudessa kaukana toisistaan,
jos niiden projektion laatu on huono.


**edit: kaavaesimerkkejä - poistetaan lopullisesta versiosta**

Korrespondenssianalyysin sovelluksissa tutkimusongelman ratkaisu on usein sopivan
matriisin rakentaminen.



\begin{equation}
A = \begin{bmatrix}
    a_{11} & a_{12} & \dots & a_{1k}\\
    \vdots & \ddots & \\
    \\
    \vdots \\
    a_{n1} & \dots  & \dots & a_{nk}
    \end{bmatrix}
\end{equation}

Ehkäpä ABBA onnistuu paremmin tällä notaatiolla?

\begin{equation}
A = \begin{bmatrix}
    A_{11} & B_{12}  \\
    B_{21} & A_{22}
    \end{bmatrix}
\end{equation}


\begin{equation}
A = \begin{bmatrix}
    A_{maa, Q1a} & A_{maa, Q1b}  \\
    B_{gage, Q1a} & B_{gage, Q1b}
    \end{bmatrix}
\end{equation}



**Pinotut tai yhdistetyt matriisit ("stacked and concatenated matrices")**

Yksinkertainen korrespondenssianalyysi on kahden luokittelumuuttujan määrittämän
taulukon analyysiä, mutta sitä voi soveltaa myös usean muuttujan analyysiin.
Menetelmän matemaattinen perusta ja ratkaisualgoritmi (SVD) toimivat, tulkinta
vain muuttuu.

Yksinkertaisin laajennus on lisätä alkuperäisen taulukon alle toinen taulukko.
Rivit ovat esimerkissä maittan summattuja vastauksia, ja niiden alle voidaan
lisätä joku toinen luokittelumuuttuja. Havaintojen määrä yhditetyssä ("pinotussa")
taulussa kaksinkertaistuu.

Taulukoiden yhdistämisen idea on inertian dekomponointi. Yhdistetyn matriisin inertia
voidaan eri tavoin esittää alimatriisien inertian summana. Tällöin jokaisen alimatriisin
reunajakauman tulee olla sama, ja puuttuvat tiedot vääristävät tuloksia.

Merkitään edellisten analyysien kuuden maan ja viiden vastausvaihtoehdon
taulukkoa matriisilla $\boldsymbol{ A}_{I  J}$, missä $I$ on rivien ja $J$
sarakkeiden lukumäärä. Taulukoidaan ikäluokan (1 - 6) ja sukupuolen ($f$ = nainen,
$m$ = mies) vuorovaikutusmuuttuja ($f1,\dots , f6$ ja $m1,\dots , m6$) samojen
vastausvaihtoehtojen kanssa. Jos tätä taulukkoa merkitään matriisilla
$\boldsymbol{ B}_{I^{`}  J}$, voimme muodostaa yhdistetyn matriisin

Rivien lukumäärä on molemmissa matriiseissa sama, koska luokkia sattuu olemaan
kuusi sekä maa- että ikä- ja sukupuoli - luokittelumuuttujissa. Kun matriisit
ovat dimensioiltaan ja myös muuttujien sisällön kannalta samankaltaiset, niitä
kutsutaan yhteensopiviksi (``matched matrix''). Tällöin yksinkertaista
korrespondenssianalyyisä voi soveltaa tutkimusongelmaan, jossa halutaan erotella
jonkun ryhmän sisäinen vaihtelu ryhmien välisiestä vaihtelusta.
(Greenacren ehdottama ABBA - analyysi).


ABBA on erityistapaus yleisemmästä moniulotteisen taulukon (multiway table) analyysistä,
jossa useita kahden muuttujan taulukoita ``pinotaan'' päällekkäin ja rinnakkain.
Voimme ottaa yhden kysymyksen vastausten lisäksi analyysiin mukaan useamman
kysymyksen vastaukset laajentamalla kahden päällekkäisen matriisin taulukkoa oikealle.
**edit poistetava pätkä loppuu tähän**

**Monimuuttujakorrespondenssianalyysi MCA**

Usean muuttujan korrespondenssianalyysissä tutkitaan usean muuttujan välisiä yhteyksiä.
Kartan tulkinnan apuna siihen voidaan lisätä havaintojen sijaan niiden keskiarvopisteitä
ja niille simuloituja luottamusellipsejä. Kuvien pääongelma on liian suuri määärä pisteitä,
ja analyysin lopputulos on usein mahdollisimman yksinkertainen kartta.

Usean muuttujan analyysissä kohteena on joko indikaattorimatriisi $\boldsymbol{Z}$ tai
Burtin matriisi $\boldsymbol{B}$

Indikaattorimatriisissa rivit ovat havaintoja ja sarakkeet luokittelumuuttujan arvoja.
Havaintoa vastaa rivi nollia ja arvo 1 valitun vastausvaihtoehdon kohdalla. Tästä seuraa,
että vain erilaiset vastaukset määrittävät rivien etäisyyksiä.

Burtin matriisi on erikoistapaus yhdistetyistä matriiseista. Siihen on koottu kaikki tutkittavien
muuttujien pareittan muodostetut taulukot. Diagonaalilla ovat muuttujien ristiintaulukoinnit
itsensä kanssa. Ratkaisu riippuu vain näistä parittaisista taulukoista. Burtin matriisi on
kätevä välivaihe matriisien yhdistelyssä.

Molemmat matriisit paisuttavat keinotekoisesti kokonaisinertiaa, ja esimerkikisi kaksiulotteisen kartan
selitetyn inertian osuudet jäävät melko pieniksi. Ratkaisuna on inertian oikaisu tai korjaus
(adjusted inertia), jossa mm. poistetaan kokonaisinertialaskelmista Burtin matriisin
diagonaalilla olevat alimatriisit. Näillä korjauksilla ei ole vaikutusta kartan pisteiden
sijaintiin. Tämä menetelmä on ca-paketin mjca-funktion oletus.

Kolmas vaihtoehto on ns. yhdistetty korrespondenssianalyysi (joint ca).

Greenacre on kirjoittanut useissa yhteyksissä MCA:n geometrisen tulkinnan ongelmista.
@RefWorks:doc:5a857a44e4b0ed2d44664d84 (s. 447) sanovat asian näin:“Finally, although
we have motivated simple correspondence analysis from the geometric point of view,
the geometry of the indicator matrix in multiple correspondence analysis is
admittedly not convincing. Distances between the row profiles of an indicator
matrix and projections of articficial column vertices have less intuitive appeal.
However, the scaling interpretation remains attractive in this case; the displays
are graphical representations of optimal scale values for the categories.”

Greenacre jatkaa samasta aiheesta artikkelikokoelmassa
[@RefWorks:doc:5ab76b43e4b003f4468d1f07 , s. 41, s. 61]: "Yleistys useammalle
kuin kahdelle muuttujalle ei ole ilmeinen eikä hyvin määritelty". Siti MCA
onnistuu esittämään hyvin kiinnostavia yhteyksiä muuttujien välillä (“succesfully
recovers interesting patterns of association”). Kriittisyys ei kuitenkaan
estä häntä soveltamasta MCA-analyysiä. Tulkitsen tämän niin, että menetelmää voi
aivan hyvin soveltaa, mutta geometrista tulkintaa ei voi suoraan siirtää CA-kartoista
MCA.karttoihin. Greenacre esittelee perusteellisesti MCA-sovelluksia kaksoiskuvia
käsittelevässä kirjassaan [@RefWorks:doc:5a857a43e4b0ed2d44664d7c]. Ehkä
korrespondenssianalyysin matemaattinen teoria ei ole vielä täysin valmis?



# Liite 2: Tekninen ympäristö ja Bookdown-paketti {-}

Analysoin aineistona r-paketilla ca, vaihtoehdoista voi mainita ranskalaisten kehittämän
FactoMineR - paketin ja muitakin löytyy. Korrespondenssianalyysin voi tehdä myös monella
muulla ohjelmistolla (esim. Survo, SAS ja SPSS). Greenacre ei ole tyytyväinen SPSS:n 
toteutukseen: "In SPSS's CA program in the Categories module,an alternative biplot
is given that has not been illustrated in this book, called the ”symmetrical normalization",
which may be confused with the symmetric map described in this book. It is not exactly the
same thing, however,since it uses standard coordinates scaled by the square roots of the singular
values (i.e. fourth roots of the principal inertias) instead of the singularvalues themselves.
Curiously, the symmetric map, one of the most popular display options of
French researchers, has never been available in SPSS (module Categories),
and it is still not possible in IBM SPSS version 20 to obtain a joint map of the rows
and columns in principalcoordinates"(CAiP, s. 296). En ole tarkastanut onko pitääkö kritiikki
yhä paikkansa.


**Bookdown**

Bookdown-paketti laajentaa R-ohjelmiston julkaisuominaisuuksia [@RefWorks:doc:5b6b36dde4b09b7ec442bf8b].
Sen avulla voi tuottaa monipuolisesti julkaisuja samalla lähdekoodilla eri formaatteihin.

Html-formaatti sopii mainiosti data-analyysiin, taulukkoita ja kuvia ei tarvitse asetella paperikoon
mukaan sivuille. PDF-formaatilla on omat etunsa, koko dokumentti on yksi tiedosto. Olen
käyttänyt bookdown-pakettia vailla suurempia ongelmia. Jos ongelmia tulee, niiden syiden 
selvittämien ei ole helppoa. Kuva \@ref(fig:L3bdprocess1) näyttää bookdownin julkaisuprosessin
vaiheet. PDF on ongelmallinen, tässä projektissa pdf-tulostus lakkasi toimimasta
kaksi kertaa. Tutkielman pdf-versio on tulosetettu selaimella, html-tiedosto on 
bookdown-paketin tulostustvaihtoehto html_book.

Ongelmat ovat varmasti ratkaistavissa, ja bookdown-paketti tai sen muokatut
versiot ovat laajassa käytössä monissa yliopistoissa. Kyse on vain
LateX-osaamattomuudesta tai ymmärtämättömyydestä.


```{r L3bdprocess1, echo = FALSE, out.width = '70%', fig.align='center',fig.cap='Tulostiedoston prosessointi'}

knitr::include_graphics('img/BookdownProc.png')

# pois out.width='50%',

```


**Git ja Github**

Käytin Github-palvelun versionhallintaa ja www-palvelua raporttien julkaisemiseen.

Tutkielman luonnos (https://hirjus.github.io/capaper/) ja lähdekoodi
(https://github.com/hirjus/capaper) löytyvät sieltä. Data on pakattuna tiedostona.


**Käyttöjärjestelmä ja R-ympäristö**

RStudio-sovelluksen ja käyttämäni TeX-versiot ovat

RStudio Version 1.3.1093, latex engine xelatex


XeTeX, Version 3.14159265-2.6-0.999992 (TeX Live 2020/W32TeX)


Bookdown-asetuksissa käyntin latex-muunnokseen aluksi pdflatex-valintaa ja
vaihdoin sen myöhemmin xelatex-vaihtoehtoon.
Ero ei ole merkittävä.

TeX-jakeluna käytin bookdown-paketin kehittäjän suosittelemaa
TinyTeX - versiota (https://yihui.org/tinytex/) ja
r-pakettia tinytex.Niiden etu on tarvittavien LaTex-pakettien
automaattinen asentaminen.

R-ympäristön tarkemmat tietot:

```{r Renviron1, echo=TRUE}

sessionInfo()

```



# Liite 3: R - koodi {-}

```{r ref.label=knitr::all_labels(), echo = T, eval = F}

# echo = FALSE toistaiseksi.
#Testataan koodilohkojen listausta, näyttää toimivan mutta vaatii vielä säätämistä.
#Ohje löytyi [Yihui Xienin blogista](https://yihui.name/en/2018/09/code-appendix/)
#(luettu 26.10.2018).

```
